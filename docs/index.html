<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <meta name='ROBOTS' content='ALL' />
    <title>COVID-19 Türkiye Güncel</title>
    <meta name='keywords' content='covid19,covid,novel covid,corona,graphics,turkey'>
    <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css'
        integrity='sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T' crossorigin='anonymous'>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.6.3/css/all.css'
        integrity='sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/' crossorigin='anonymous'>
    <link rel='stylesheet' href='https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.css'>
    <script src='https://cdn.jsdelivr.net/npm/apexcharts'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js'
        integrity='sha256-AdQN98MVZs44Eq2yTwtoKufhnU+uZ7v2kXnD5vqzZVo=' crossorigin='anonymous'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.28/moment-timezone-with-data.min.js'
        integrity='sha256-IWYg4uIC8/erItNXYvLtyYHioRi2zT1TFva8qaAU/ww=' crossorigin='anonymous'></script>
</head>

<body style='padding: 20px; margin-top:10px; padding-top:0px'>
    <div class='float-left'>
        <a href='https://github.com/ozanerturk/covid19-turkey-api' id="source">Kaynak</a>
    </div>
    <div class='text-right text-secondary' id="lastUpdateLang">
        <span id="lastUpdateLabel">Son güncelleme:</span> <abbr id='lastUpdate'></abbr>
    </div>
    <div class='float-right'>
        <a href='https://raw.githubusercontent.com/ozanerturk/covid19-turkey-api/master/dataset/timeline.json'>JSON</a>
        <a href='https://raw.githubusercontent.com/ozanerturk/covid19-turkey-api/master/dataset/timeline.csv'>CSV</a>
    </div>

    <div class='container-fluid'>
        <div class='row justify-content-md-center mt-4'>
            <div class='col-md-auto' id="today">
                <h1>Bugün</h1>
            </div>
        </div>
        <div class='row mt-4'>
            <div class='col'>
                <table id='tableBugun'>
                </table>
            </div>
        </div>
        <div class='row'>
            <div class='col-12 col-lg-9'>
                <div id='chart'></div>
            </div>
            <div class='col-12 col-lg-3'>
                <div id='pieChart'></div>
            </div>
        </div>
        <div class='row'>
            <!-- <div class='col col-lg-4 col-sm-12 col-md-12'>
                <div id='logarithmicChart'></div>
            </div> -->
            <div class='col-12 col-lg-6'>
                <div id='logarithmicChartForNewPat'></div>
            </div>
            <div class='col-12 col-lg-6'>
                <div id='speedChart'></div>
            </div>
        </div>
    </div>
    
    <table id='table'>
    </table>

    <script src='https://code.jquery.com/jquery-3.3.1.min.js'
        integrity='sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=' crossorigin='anonymous'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js'
        integrity='sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1' crossorigin='anonymous'>
        </script>
    <script src='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js'
        integrity='sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM' crossorigin='anonymous'>
        </script>
    <script src='https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.js'></script>

    <script>
        //language customization
        var language = navigator.language.substr(0, 2)
        if (language != 'tr' && language != 'en')
            language = 'en';

        var en = {
            cases: "cases",
            totalCases: "total cases",
            deaths: "deaths",
            totalDeaths: "total Deaths",
            recovered: "recovered",
            totalRecovered: "total Recovered",
            totalIntubated: "total Intubated",
            totalIntensiveCare: "total Intensive care",
            tests: "tests",
            totalTests: "total tests",
            date: "date",
            newCases: "new cases",
            currentCases: "current cases",
            covidTurkey: 'COVID-19 Turkey Current Status',
            logarithmicCaseIncrease: 'logarithmic case Increase',
            dailyCases: 'daily Cases',
            caseIncreasePercentage: 'case Increase percentage',
            source: 'source',
            today: 'today',
            lastUpdateLabel: 'last update',
        };

        var tr = {
            cases: "vaka",
            totalCases: "toplam vaka",
            deaths: "vefat",
            totalDeaths: "toplam vefat",
            recovered: "iyileşen",
            totalRecovered: "toplam iyileşen",
            totalIntubated: "toplan entübe",
            totalIntensiveCare: "toplam yoğun bakım",
            tests: "test sayısı",
            totalTests: "toplam test sayısı",
            date: "tarih",
            newCases: "yeni vaka",
            currentCases: "aktif vaka",
            covidTurkey: 'COVID-19 Türkiye Güncel Durum',
            logarithmicCaseIncrease: 'logaritmik vaka artışı',
            dailyCases: 'Günlük Vaka',
            caseIncreasePercentage: 'vaka artış yüzdesi',
            source: 'kaynak',
            today: 'bugün',
            lastUpdateLabel: 'son güncelleme',
        };

        function setLanguage(key, getUpper) {
            var text = eval(language + "." + key);
            if (getUpper != undefined && getUpper) {
                return capitalizeFirstLetter(text);
            }
            return text;
        };

        function capitalizeFirstLetter(s) {
            var temp = s.split(' ');
            if (temp.length - 1 > 0) {
                var result = '';
                temp.forEach(element => {
                    result += element.charAt(0, 1).toUpperCase() + element.slice(1) + ' ';
                });
                return result.substr(0, result.length - 1);
            } else {
                return s.charAt(0).toUpperCase() + s.slice(1);
            }
        };
        document.querySelector('#source').text = setLanguage("source", true);
        document.querySelector('#today h1').textContent = setLanguage("today", true);

        //end language customization

        const pieOptions = {
            series: [],
            chart: {
                type: 'pie'
            },
            title: {
                text: '',
                align: 'left',
                offsetX: 110
            },
            colors: ['#008FFB', '#00E396', '#FF0000'],
            labels: [setLanguage('currentCases', true), setLanguage('recovered', true), setLanguage('deaths', true)]
        };

        const logarithmicOptions = {
            series: [],
            chart: {
                height: 350,
                type: 'line',
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            title: {
                text: setLanguage('logarithmicCaseIncrease', true),
                align: 'left'
            },
            xaxis: {
                categories: []
            },
            colors: ['#008FFB'],
            yaxis: {
                seriesName: setLanguage('cases'),
                logarithmic: true
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    yaxis: [],
                },
            }],
        };

        //Logarithmic for new patients
        const logarithmicNewPatOptions = {
            series: [],
            chart: {
                height: 350,
                type: 'line',
                zoom: {
                    enabled: true
                }
            },
            stroke: {
                show: true,
                curve: 'straight',
                lineCap: 'butt',
                colors: undefined,
                width: 2,
                dashArray: 0,
            },
            markers: {
                size: 4,
                colors: undefined,
                strokeColors: '#fff',
                strokeWidth: 1,
                strokeOpacity: 0.9,
                strokeDashArray: 0,
                fillOpacity: 1,
                discrete: [],
                shape: "circle",
                radius: 2,
                offsetX: 0,
                offsetY: 0,
                onClick: undefined,
                onDblClick: undefined,
                showNullDataPoints: true,
                hover: {
                    size: undefined,
                    sizeOffset: 3
                }
            },
            dataLabels: {
                enabled: false
            },
            title: {
                text: setLanguage('caseIncreasePercentage', true),
                align: 'left'
            },
            xaxis: {
                type: 'numeric',
                tickAmount: 'dataPoints',

                labels: {
                    formatter: function (value) {
                        return Math.round(Math.pow(10, +value));
                    }
                },
                title: {
                    text: setLanguage('totalCases', true),
                    style: {
                        color: '#000'
                    }
                },
            },
            colors: ['#008FFB'],
            yaxis: {
                tickAmount: 7,
                type: 'numeric',
                logarithmic: true,
                title: {
                    text: setLanguage('newCases', true),
                    style: {
                        color: '#000'
                    }
                },
                labels: {
                    formatter: function (value) {
                        return Math.round(Math.pow(10, +value))
                    }
                }
            },
            tooltip: {
                enabled: true,
                custom: function ({
                    series,
                    seriesIndex,
                    dataPointIndex,
                    w
                }) {
                    return '<div class="arrow_box">' +
                        `<div>
                            <b> ${setLanguage('date',true)}: ${w.config.series[0].data[dataPointIndex][3]}</b>
                        </div> 
                        <div>
                           ${setLanguage('caseIncreasePercentage',true)}: ${ w.config.series[0].data[dataPointIndex][2]} 
                        </div>
                        <div>
                            ${setLanguage('cases',true)}: ${Math.round(Math.pow(10, w.config.series[0].data[dataPointIndex][1]))}
                        </div>
                        <div>
                            ${setLanguage('totalCases',true)}: ${Math.round(Math.pow(10, w.config.series[0].data[dataPointIndex][0]))}
                        </div>
                        </div>`
                }
            }
        };

        const speedOptions = {
            series: [],
            chart: {
                height: 350,
                type: 'line',
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'straight'
            },
            title: {
                text: setLanguage('dailyCases', true) + ' / ' + setLanguage('deaths', true),
                align: 'left'
            },
            xaxis: {
                categories: []
            },
            colors: ['#008FFB', '#FF0000'],
            yaxis: [{
                seriesName: setLanguage('cases'),
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: '#008FFB'
                },
                labels: {
                    style: {
                        colors: '#008FFB'
                    }
                },
                title: {
                    text: setLanguage('cases', true),
                    style: {
                        color: '#008FFB'
                    }
                },
                tooltip: {
                    enabled: true
                }
            },
            {
                seriesName: setLanguage('deaths'),
                opposite: true,
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: '#FF0000'
                },
                labels: {
                    style: {
                        colors: '#FF0000'
                    }
                },
                title: {
                    text: setLanguage('deaths', true),
                    style: {
                        color: '#FF0000'
                    }
                }
            }
            ],
            responsive: [{
                breakpoint: 768,
                options: {
                    yaxis: [],
                },
            }],
        };

        const options = {
            series: [],
            chart: {
                height: 350,
                type: 'line',
                stacked: false
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                width: [2, 2, 2]
            },
            title: {
                text: setLanguage('covidTurkey'),
                align: 'left',
                offsetX: 110
            },
            xaxis: {
                categories: []
            },
            colors: ['#008FFB', '#FF0000', '#00E396', '#BBBBBB'],
            yaxis: [{
                seriesName: setLanguage('cases'),
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: '#008FFB'
                },
                labels: {
                    style: {
                        colors: '#008FFB'
                    },
                },
                title: {
                    text: setLanguage('cases', true),
                    style: {
                        color: '#008FFB'
                    }
                },
                tooltip: {
                    enabled: true
                }
            },
            {
                seriesName: setLanguage('deaths'),
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: '#FF0000'
                },
                labels: {
                    style: {
                        colors: '#FF0000'
                    }
                },
                title: {
                    text: setLanguage('deaths', true),
                    style: {
                        color: '#FF0000'
                    }
                }
            },
            {
                seriesName: setLanguage('recovered'),
                opposite: true,
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: '#00E396'
                },
                labels: {
                    style: {
                        colors: '#00E396'
                    }
                },
                title: {
                    text: setLanguage('recovered', true),
                    style: {
                        color: '#00E396'
                    }
                }
            },
            {
                seriesName: setLanguage('tests'),
                opposite: true,
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: '#FEB019'
                },
                labels: {
                    style: {
                        colors: '#FEB019'
                    }
                },
                title: {
                    text: setLanguage('tests', true),
                    style: {
                        color: '#FEB019'
                    }
                }
            }
            ],
            tooltip: {
                fixed: {
                    enabled: true,
                    position: 'topLeft', // topRight, topLeft, bottomRight, bottomLeft
                    offsetY: 30,
                    offsetX: 60
                }
            },
            legend: {
                horizontalAlign: 'left',
                offsetX: 40
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    yaxis: [],
                    tooltip: {
                        fixed: {
                            offsetY: 70,
                            offsetX: 70,
                        },
                        style: {
                            fontSize: '11px',
                        },
                    },
                    title: {
                        offsetX: 70
                    },
                },
            },{
                breakpoint: 576,
                options: {
                    tooltip: {
                        fixed: {
                            offsetY: 90,
                            offsetX: 0,
                        },
                        style: {
                            fontSize: '8px',
                        },
                    },
                    title: {
                        offsetX: 0
                    },
                },
            }],
        };

        const lastCheckHeaders = new Headers({
            'Accept': 'application/vnd.github.antiope-preview+json'
        });
        const lastCheckRequest = new Request(
            'https://api.github.com/repos/ozanerturk/covid19-turkey-api/actions/workflows/950217/runs?status=completed&page=1&per_page=1', {
            method: 'GET',
            headers: lastCheckHeaders,
            mode: 'cors',
            cache: 'default'
        });
        fetch(lastCheckRequest)
            .then(res => res.json())
            .then(json => {
                const time = moment.tz(json.workflow_runs[0].updated_at, 'YYYY-MM-DDTHH:mm:ss:SSS',
                    'Europe/Istanbul').add('+3', 'hours');

                const lastUpdateLabel = document.getElementById('lastUpdateLabel')
                const lastUpdateElement = document.getElementById('lastUpdate');
                lastUpdateLabel.innerText = setLanguage('lastUpdateLabel', true)
                lastUpdateElement.innerText = time.local().fromNow();
                lastUpdateElement.title = time.format();
            });

        moment.locale(language);
        fetch('https://raw.githubusercontent.com/ozanerturk/covid19-turkey-api/master/dataset/timeline.json')
            .then(res => res.json())
            .then(res => {
                const dates = Object.keys(res).map(x => moment(x, 'DD/MM/YYYY').format('DD MMM'));
                const values = Object.values(res);

                options.series.push({
                    name: setLanguage('cases'),
                    type: 'line',
                    data: values.map(x => x.totalCases)
                });
                options.series.push({
                    name: setLanguage('deaths'),
                    type: 'line',
                    data: values.map(x => x.totalDeaths)
                });
                options.series.push({
                    name: setLanguage("recovered"),
                    type: 'line',
                    data: values.map(x => x.totalRecovered)
                });
                options.series.push({
                    name: setLanguage('tests'),
                    type: 'column',
                    data: values.map(x => x.tests)
                });
                options.xaxis.categories = dates;
                const chart = new ApexCharts(document.querySelector('#chart'), options);
                chart.render();

                var matchedList = values.map(t => {
                    return [Math.log10(+t.totalCases), Math.log10(+t.cases), Math.round(
                        parseInt(t.cases) * 100 / parseInt(t.totalCases)) + "%", t.date]
                });

                matchedList.splice(0, 4);

                logarithmicNewPatOptions.series = [{
                    name: setLanguage('cases'),
                    data: matchedList
                }];

                const logarithmicNewPatChart = new ApexCharts(document.querySelector('#logarithmicChartForNewPat'),
                    logarithmicNewPatOptions);
                logarithmicNewPatChart.render();

                //pie
                const last = values[values.length - 1];
                pieOptions.series.push(last.totalCases - last.totalRecovered - last.totalDeaths);
                pieOptions.series.push(+last.totalRecovered);
                pieOptions.series.push(+last.totalDeaths);
                const pieChart = new ApexCharts(document.querySelector('#pieChart'), pieOptions);
                pieChart.render();

                //speed
                speedOptions.series.push({
                    name: setLanguage('cases'),
                    type: 'line',
                    data: values.map(x => x.cases)
                });
                speedOptions.series.push({
                    name: setLanguage('deaths'),
                    type: 'line',
                    data: values.map(x => x.deaths)
                });
                speedOptions.xaxis.categories = dates;
                const speedChart = new ApexCharts(document.querySelector('#speedChart'), speedOptions);
                speedChart.render();

                const tableData = Object.values(res).reverse();
                const tableConfig = {
                    columns: [{
                        field: 'date',
                        title: setLanguage('date', true)
                    },
                    {
                        field: 'tests',
                        title: setLanguage('tests', true)
                    },
                    {
                        field: 'cases',
                        title: setLanguage('cases', true)
                    },
                    {
                        field: 'recovered',
                        title: setLanguage('recovered', true)
                    },
                    {
                        field: 'deaths',
                        title: setLanguage('deaths', true)
                    },
                    {
                        field: 'totalTests',
                        title: setLanguage('totalTests', true)
                    },
                    {
                        field: 'totalCases',
                        title: setLanguage('totalCases', true)
                    },
                    {
                        field: 'totalRecovered',
                        title: setLanguage('totalRecovered', true)
                    },
                    {
                        field: 'totalDeaths',
                        title: setLanguage('totalDeaths', true)
                    },
                    {
                        field: 'totalIntubated',
                        title: setLanguage('totalIntubated', true)
                    },
                    {
                        field: 'totalIntensiveCare',
                        title: setLanguage('totalIntensiveCare', true)
                    }
                    ]
                };

                const tableAllConfig = Object.assign({}, tableConfig);
                tableAllConfig.data = tableData;
                $('#table').bootstrapTable(tableAllConfig);
                const tableBugunConfig = Object.assign({}, tableConfig);
                tableBugunConfig.data = [tableData[0]];
                $('#tableBugun').bootstrapTable(tableBugunConfig);
            });
    </script>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }

        .container {
            display: flex;
            align-items: stretch;
        }

        #chart {
            flex: 1;
            margin: 35px auto;
        }

        #chart .apexcharts-tooltip {
            display: flex;
            border: 0;
            margin-top: -30px;
            box-shadow: none;
        }
    </style>
</body>

</html>